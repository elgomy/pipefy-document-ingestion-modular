De acuerdo. Entiendo la necesidad de un documento formal y estructurado que sirva como gu√≠a definitiva para el desarrollo, especialmente si se va a entregar a un agente de IA como Cursor.

A continuaci√≥n, presento el Product Requirements Document (PRD) completo para el **Agente de Triagem Documental v2.0**, incorporando tus √∫ltimos ajustes y siguiendo la estructura solicitada.

\<PRD\>

# Product Requirements Document: Agente de Triagem Documental v2.0

### 1\. Introduction

Este documento proporciona una descripci√≥n detallada de los requisitos para el desarrollo de la versi√≥n 2.0 del **Agente de Triagem Documental**. El prop√≥sito de este proyecto es mejorar y automatizar la fase inicial de an√°lisis de documentos en el proceso de `cadastro` de clientes de la FIDC.

Este PRD servir√° como la fuente √∫nica de verdad para el equipo de desarrollo, delineando el alcance, las caracter√≠sticas y los criterios de √©xito del proyecto.

**Nota Importante para el Desarrollo:** El enfoque de esta fase del proyecto es 100% en el perfeccionamiento del `triagem_agente`. Los agentes previamente conceptualizados (`extrator_agente` y `risco_agente`) quedan en **stand-by** y su desarrollo no forma parte del alcance de este documento.

### 2\. Product overview

El "Pipefy Document Analysis Platform" es una soluci√≥n modular de software dise√±ada para automatizar y optimizar el proceso de an√°lisis de riesgo y cumplimiento para nuevos clientes (cedentes). Integrando Pipefy como interfaz de usuario, Supabase como backend de datos, y CrewAI como cerebro de an√°lisis, la plataforma tiene como objetivo reducir dr√°sticamente el trabajo manual, minimizar errores humanos y acelerar el tiempo de aprobaci√≥n de los cadastros.

Este feature espec√≠fico, "Agente de Triagem Documental v2.0", se centra en la primera y m√°s cr√≠tica etapa del flujo: la validaci√≥n de que toda la documentaci√≥n enviada por el cliente est√° completa y cumple con los requisitos del checklist.

### 3\. Goals and objectives

El objetivo principal de este feature es transformar la triagem documental de un proceso manual y lento a un flujo automatizado, inteligente y eficiente.

  * **Objetivo 1:** Automatizar completamente la clasificaci√≥n de los casos entrantes, moviendo autom√°ticamente cada card de Pipefy a la fase correcta seg√∫n la calidad de su documentaci√≥n.
  * **Objetivo 2:** Reducir el tiempo del ciclo de la fase de triagem en un 80%, pasando de d√≠as a minutos.
  * **Objetivo 3:** Eliminar en un 95% los casos devueltos por el "Fundo Singulare" debido a errores documentales b√°sicos.
  * **Objetivo 4:** Mejorar la eficiencia del equipo (comercial y de cadastro) proveyendo informaci√≥n clara, instant√°nea y accionable.

### 4\. Target audience

  * **Equipe de Cadastro:** Son los usuarios primarios que se beneficiar√°n de la automatizaci√≥n. En lugar de revisar manualmente cada documento, recibir√°n casos pre-clasificados, enfoc√°ndose solo en aquellos que requieren acciones internas espec√≠ficas (como la emisi√≥n de documentos).
  * **Gestor Comercial:** Son los usuarios que necesitan ser notificados de forma inmediata cuando una acci√≥n de su parte (o del cliente) es requerida para desbloquear un proceso. La notificaci√≥n autom√°tica les permitir√° actuar con mayor agilidad.

### 5\. Features and requirements

  * **FR-01: Clasificaci√≥n Automatizada de Casos:** El sistema debe analizar la documentaci√≥n y clasificar cada caso en una de tres categor√≠as: `Aprovado`, `Pendencia_Bloqueante`, o `Pendencia_NaoBloqueante`.
  * **FR-02: Movimiento Autom√°tico de Cards en Pipefy:** Basado en la clasificaci√≥n del FR-01, el sistema debe mover el card de Pipefy a la fase correspondiente:
      * `Aprovado` ‚Üí Fase "Aprovado" (ID: `338000018`)
      * `Pendencia_Bloqueante` ‚Üí Fase "Pend√™ncias Documentais" (ID: `338000017`)
      * `Pendencia_NaoBloqueante` ‚Üí Fase "Emitir documentos" (ID: `338000019`)
  * **FR-03: Generaci√≥n de Informe Detallado:** El agente de IA debe generar un informe en formato Markdown que detalle el estado de cada √≠tem del checklist y explique claramente cada pendencia encontrada.
  * **FR-04: Actualizaci√≥n de Campo en Pipefy:** El informe generado (FR-03) debe ser insertado en el campo de Pipefy con ID **`informe_triagem_crewai`**.
  * **FR-05: Notificaci√≥n Autom√°tica por WhatsApp:** Para los casos clasificados como `Pendencia_Bloqueante`, el sistema debe enviar una notificaci√≥n v√≠a WhatsApp al gestor comercial responsable.
  * **FR-06: Generaci√≥n Autom√°tica de `Cart√£o CNPJ`:** Para los casos clasificados como `Pendencia_NaoBloqueante` donde el `Cart√£o CNPJ` est√© ausente o desactualizado, el sistema debe intentar generar el documento autom√°ticamente usando la API de CNPJ√°.
  * **FR-07: Toma de Decisiones Basada en Conocimiento:** El agente de IA debe basar sus decisiones en dos fuentes principales: el contenido del checklist activo (obtenido de la tabla `checklist_config` en Supabase) y el `FAQ.pdf` (cargado en la `KnowledgeBase` de CrewAI).

### 6\. User stories and acceptance criteria

| ID | User Story | Acceptance Criteria |
| :--- | :--- | :--- |
| **ST-101** | Como miembro de la `Equipe de Cadastro`, quiero que los casos con toda la documentaci√≥n correcta sean movidos autom√°ticamente a la fase "Aprovado", para poder enfocarme en los casos que realmente necesitan mi atenci√≥n. | 1. Un card con documentos 100% conformes se mueve de la fase "Triagem Documentos AI" a la fase "Aprovado" (ID: `338000018`).\<br\>2. El campo `informe_triagem_crewai` se actualiza con un mensaje de √©xito. |
| **ST-102** | Como `Gestor Comercial`, quiero ser notificado instant√°neamente por WhatsApp cuando un caso que envi√© tiene un problema cr√≠tico que debo resolver, para poder contactar al cliente r√°pidamente. | 1. Un card con una pendencia bloqueante se mueve a la fase "Pend√™ncias Documentais" (ID: `338000017`).\<br\>2. Se env√≠a un mensaje de WhatsApp al n√∫mero configurado.\<br\>3. El campo `informe_triagem_crewai` contiene el detalle del error. |
| **ST-103** | Como miembro de la `Equipe de Cadastro`, quiero que los casos con pendencias que podemos resolver internamente (como un `Cart√£o CNPJ` desactualizado) sean movidos a una cola de trabajo espec√≠fica ("Emitir documentos"), para saber exactamente qu√© documentos necesito generar. | 1. Un card con una pendencia no bloqueante se mueve a la fase "Emitir documentos" (ID: `338000019`).\<br\>2. El sistema intenta ejecutar las acciones autom√°ticas (como generar el `Cart√£o CNPJ`).\<br\>3. El campo `informe_triagem_crewai` detalla las acciones autom√°ticas tomadas y/o las que se deben realizar manualmente. |
| **ST-104** | Como Administrador del Sistema, quiero que toda la comunicaci√≥n entre servicios (Ingesti√≥n, CrewAI, Pipefy, Supabase, etc.) sea autenticada mediante tokens seguros para prevenir accesos no autorizados. | 1. Todas las claves de API (Pipefy, Supabase, Twilio, CNPJ√°, OpenAI) se cargan desde variables de entorno y no est√°n hardcodeadas en el c√≥digo.\<br\>2. Las llamadas entre servicios internos (Ingesti√≥n a CrewAI) est√°n protegidas. |
| **ST-105** | Como Desarrollador, necesito que la tabla `checklist_config` en Supabase est√© estructurada para contener el contenido del checklist activo, de modo que el sistema pueda obtener las reglas de negocio din√°micamente sin necesidad de un redespliegue. | 1. La tabla `checklist_config` existe en Supabase con los campos `name` (TEXT), `checklist_content` (JSONB), y `is_active` (BOOLEAN).\<br\>2. El Servicio de Ingesti√≥n puede conectarse y obtener con √©xito el contenido del checklist donde `is_active = true`. |
| **ST-106** | Como Administrador del Sistema, quiero que el sistema maneje fallos en las APIs externas (ej. Twilio o CNPJ√° est√°n ca√≠dos) de forma elegante, registrando el error y notificando al equipo de operaciones para asegurar que ning√∫n caso se pierda o quede en un estado inconsistente. | 1. Si una llamada a una API externa (Twilio, CNPJ√°) falla, el error se registra en los logs de Render.\<br\>2. El card de Pipefy se actualiza con un comentario indicando el fallo de la automatizaci√≥n.\<br\>3. El card NO se mueve o se mueve a una fase espec√≠fica de "Error de Automatizaci√≥n" para revisi√≥n manual. |

### 7\. Technical requirements / Stack

  * **Lenguaje:** Python 3.11+
  * **Frameworks:** FastAPI (para los servicios web), CrewAI (para la orquestaci√≥n de agentes).
  * **Plataforma de Despliegue:** Render.
  * **Backend de Datos:** Supabase (PostgreSQL y Storage).
  * **APIs Externas:**
      * Pipefy (GraphQL API)
      * OpenAI (API de LLM)
      * LlamaCloud (API de LlamaParse)
      * Twilio (Messaging API para WhatsApp)
      * CNPJ√° (API para generaci√≥n de documentos)

### 8\. Design and user interface

La interfaz de usuario principal para este feature sigue siendo el tablero Kanban de **Pipefy**. No se requiere el desarrollo de una nueva interfaz gr√°fica. Los cambios de UI se limitan a:

  * La creaci√≥n de la nueva fase **"Emitir documentos"** en el pipe.
  * La poblaci√≥n autom√°tica del campo de tipo "Texto Longo" **`informe_triagem_crewai`** con el resultado del an√°lisis del agente.

\</PRD\>

-----

### **Anexo: C√≥digo Sugerido para Implementaci√≥n**

¬°Claro! A continuaci√≥n, te proporciono el c√≥digo detallado para las funciones de ayuda que necesita el **Servicio de Ingesti√≥n**.

Este c√≥digo est√° dise√±ado para ser modular y puede ser ubicado en un archivo como `integrations.py` o `utils.py` dentro de tu proyecto `pipefy-document-ingestion-modular`. Incluye el manejo de errores b√°sicos y utiliza las variables de entorno como se defini√≥ en la arquitectura.

---

### **C√≥digo de Funciones de Ayuda para el Servicio de Ingesti√≥n**

```python
import os
import httpx
from twilio.rest import Client
# Asumimos que tienes un cliente de Supabase inicializado en alguna parte de tu aplicaci√≥n
# from your_app.supabase import supabase_client 

# --- Constantes de Configuraci√≥n ---
PIPEFY_API_URL = "https://api.pipefy.com/graphql"
PIPEFY_TOKEN = os.environ.get("PIPEFY_TOKEN")
TWILIO_ACCOUNT_SID = os.environ.get("TWILIO_ACCOUNT_SID")
TWILIO_AUTH_TOKEN = os.environ.get("TWILIO_AUTH_TOKEN")
TWILIO_WHATSAPP_NUMBER = os.environ.get("TWILIO_WHATSAPP_NUMBER", "+17245586619")
CNPJA_API_KEY = os.environ.get("CNPJA_API_KEY")
CNPJA_API_URL = "https://api.cnpja.com/rfb/certificate"

# IDs de Fases y Campos de Pipefy
FIELD_ID_INFORME_TRIAGEM = "informe_triagem_crewai"

# --- Funciones de Integraci√≥n con Pipefy ---

def move_pipefy_card(card_id: str, phase_id: str):
    """
    Mueve un card de Pipefy a una fase espec√≠fica usando la API GraphQL.
    
    Args:
        card_id (str): El ID del card a mover.
        phase_id (str): El ID de la fase de destino.
    """
    mutation = """
    mutation($cardId: ID!, $phaseId: ID!) {
      moveCardToPhase(input: {card_id: $cardId, destination_phase_id: $phaseId}) {
        card {
          id
          title
          current_phase {
            id
            name
          }
        }
      }
    }
    """
    variables = {"cardId": str(card_id), "phaseId": str(phase_id)}
    headers = {"Authorization": f"Bearer {PIPEFY_TOKEN}", "Content-Type": "application/json"}
    
    try:
        with httpx.Client() as client:
            response = client.post(PIPEFY_API_URL, json={"query": mutation, "variables": variables}, headers=headers, timeout=30)
            response.raise_for_status()
            result = response.json()
            if result.get("errors"):
                print(f"ERRO da API Pipefy ao mover card {card_id}: {result['errors']}")
            else:
                new_phase = result['data']['moveCardToPhase']['card']['current_phase']['name']
                print(f"Card {card_id} movido com sucesso para a fase '{new_phase}' (ID: {phase_id}).")
    except httpx.HTTPStatusError as e:
        print(f"ERRO HTTP ao mover card {card_id} no Pipefy: {e.response.status_code} - {e.response.text}")
    except Exception as e:
        print(f"ERRO inesperado ao mover card {card_id}: {e}")

def update_pipefy_field(card_id: str, field_id: str, value: str):
    """
    Actualiza el valor de un campo espec√≠fico en un card de Pipefy.
    
    Args:
        card_id (str): El ID del card a actualizar.
        field_id (str): El ID del campo a modificar (ej. "informe_triagem_crewai").
        value (str): El nuevo valor para el campo (el informe en Markdown).
    """
    mutation = """
    mutation($cardId: ID!, $fieldId: ID!, $newValue: JSON!) {
      updateCardField(input: {card_id: $cardId, field_id: $fieldId, value: $newValue}) {
        card {
          id
        }
        success
      }
    }
    """
    variables = {"cardId": str(card_id), "fieldId": field_id, "newValue": value}
    headers = {"Authorization": f"Bearer {PIPEFY_TOKEN}", "Content-Type": "application/json"}
    
    try:
        with httpx.Client() as client:
            response = client.post(PIPEFY_API_URL, json={"query": mutation, "variables": variables}, headers=headers, timeout=30)
            response.raise_for_status()
            result = response.json()
            if result.get("errors"):
                print(f"ERRO da API Pipefy ao atualizar campo {field_id} no card {card_id}: {result['errors']}")
            elif result.get("data", {}).get("updateCardField", {}).get("success"):
                print(f"Campo '{field_id}' do card {card_id} atualizado com sucesso.")
            else:
                print(f"Falha ao atualizar campo {field_id} no card {card_id}. Resposta: {result}")

    except httpx.HTTPStatusError as e:
        print(f"ERRO HTTP ao atualizar campo no card {card_id}: {e.response.status_code} - {e.response.text}")
    except Exception as e:
        print(f"ERRO inesperado ao atualizar campo no card {card_id}: {e}")

# --- Funciones de Integraci√≥n con APIs de Terceros ---

def send_whatsapp_notification(card_id: str, relatorio: str):
    """
    Envia una notificaci√≥n de pendencia bloqueante v√≠a Twilio.
    
    Args:
        card_id (str): ID del card para incluir en el mensaje.
        relatorio (str): El informe de la IA para resumir en el mensaje.
    """
    # TODO: Implementar l√≥gica para obtener el tel√©fono del gestor a partir del card_id.
    # Esta informaci√≥n podr√≠a estar en un campo del card o en una base de datos de usuarios.
    numero_gestor_exemplo = "+553199999999"  # Placeholder - ¬°USAR N√öMERO REAL PARA PRUEBAS!
    
    if not all([TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN]):
        print("ERRO: Credenciais da Twilio n√£o configuradas. Notifica√ß√£o n√£o enviada.")
        return

    try:
        client = Client(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN)
        message_body = (
            f"üö® Pend√™ncia Cr√≠tica no Pipefy!\n\n"
            f"Card: https://app.pipefy.com/open-cards/{card_id}\n\n"
            f"Resumo da Pend√™ncia: {relatorio[:200]}...\n\n"
            f"Por favor, verifique o card para detalhes e a√ß√£o necess√°ria."
        )
        message = client.messages.create(
            from_=f"whatsapp:{TWILIO_WHATSAPP_NUMBER}",
            body=message_body,
            to=f'whatsapp:{numero_gestor_exemplo}'
        )
        print(f"Notifica√ß√£o de WhatsApp enviada para {numero_gestor_exemplo}. SID: {message.sid}")
    except Exception as e:
        print(f"ERRO CR√çTICO ao enviar WhatsApp via Twilio: {e}")

def gerar_e_armazenar_cartao_cnpj(case_id: str, cnpj: str):
    """
    Genera el Cart√£o CNPJ usando la API de CNPJ√° y lo almacena en Supabase.
    
    Args:
        case_id (str): El ID del caso, usado para nombrar el archivo.
        cnpj (str): El n√∫mero del CNPJ (solo d√≠gitos).
    """
    print(f"Iniciando gera√ß√£o de Cart√£o CNPJ para {cnpj} no caso {case_id}...")
    if not CNPJA_API_KEY:
        print("ERRO: API Key da CNPJ√° n√£o configurada. Gera√ß√£o de documento cancelada.")
        return

    headers = {'Authorization': CNPJA_API_KEY}
    params = {'taxId': cnpj, 'pages': 'REGISTRATION'}
    
    try:
        with httpx.Client() as client:
            response = client.get(CNPJA_API_URL, params=params, headers=headers, timeout=60)
            response.raise_for_status()
            pdf_content = response.content

            print(f"PDF do Cart√£o CNPJ obtido com sucesso ({len(pdf_content)} bytes).")

            # --- L√≥gica de Upload para Supabase ---
            # TODO: Asegurarse de que el cliente de Supabase est√© inicializado.
            # file_path = f"{case_id}/cartao_cnpj_gerado_auto.pdf"
            # response = supabase_client.storage.from_('documents').upload(file_path, pdf_content, {"content-type": "application/pdf"})
            
            # TODO: A√±adir el nuevo documento a la tabla 'documents' de Supabase
            # new_document_url = supabase_client.storage.from_('documents').get_public_url(file_path)
            # supabase_client.table('documents').insert({ "case_id": case_id, "file_name": "cartao_cnpj_gerado_auto.pdf", "file_url": new_document_url, ... })
            
            print(f"Simula√ß√£o: Upload do Cart√£o CNPJ para Supabase Storage e registro na DB conclu√≠dos.")

    except httpx.HTTPStatusError as e:
        print(f"ERRO HTTP ao chamar API da CNPJ√°: {e.response.status_code} - {e.response.text}")
    except Exception as e:
        print(f"ERRO inesperado ao gerar Cart√£o CNPJ: {e}")

```