# üìù Rellenado Program√°tico del Campo `informe_crewai_2` en Pipefy

## üìã Descripci√≥n General

El campo `informe_crewai_2` es un campo personalizado de Pipefy que contiene el informe de an√°lisis de documentos generado autom√°ticamente por CrewAI. Este documento explica todo el proceso de rellenado program√°tico de este campo, desde la configuraci√≥n hasta la implementaci√≥n.

---

## üéØ Informaci√≥n del Campo

### Identificaci√≥n del Campo
- **ID del Campo**: `informe_crewai_2`
- **Nombre Visual**: "Informe CrewAI"  
- **Tipo**: `long_text` (texto largo)
- **Descripci√≥n**: Informe generado autom√°ticamente por CrewAI con an√°lisis de documentos
- **Obligatorio**: No
- **Editable**: S√≠

### Configuraci√≥n Autom√°tica
```python
# Configuraci√≥n centralizada en src/config/settings.py
FIELD_ID_INFORME: str = os.getenv("FIELD_ID_INFORME", "informe_crewai_2")
```

---

## üîß Arquitectura del Sistema

### 1. Flujo Completo de Rellenado

```mermaid
graph TD
    A[Webhook Pipefy] --> B[Descargar Documentos]
    B --> C[Subir a Supabase Storage]
    C --> D[Llamar Servicio CrewAI]
    D --> E[Recibir An√°lisis IA]
    E --> F[**Actualizar Campo informe_crewai_2**]
    F --> G[Mover Card por Clasificaci√≥n]
```

### 2. Componentes Involucrados

#### **Servicio de Ingesti√≥n** (`pipefy-document-ingestion-v2`)
- Coordina todo el proceso
- Actualiza el campo en Pipefy
- Maneja errores y reintentos

#### **Servicio CrewAI** (`pipefy-crewai-analysis-v2`) 
- Genera el an√°lisis de documentos
- Devuelve el informe estructurado
- Usa FAQ.pdf como conocimiento base

---

## üõ†Ô∏è Implementaci√≥n T√©cnica

### 1. Funci√≥n Principal de Actualizaci√≥n

```python
async def update_pipefy_informe_crewai_field(card_id: str, informe_content: str) -> bool:
    """
    Actualiza el campo 'Informe CrewAI' en Pipefy usando el field_id fijo descubierto.
    
    SOLUCI√ìN DEFINITIVA:
    - Field ID fijo: "informe_crewai_2" (descubierto mediante query pipe.start_form_fields)
    - Sintaxis oficial: updateCardField con card_id, field_id, new_value
    - Sin b√∫squedas din√°micas ni creaci√≥n de campos
    
    Args:
        card_id: ID del card de Pipefy
        informe_content: Contenido del informe a actualizar
    
    Returns:
        bool: True si la actualizaci√≥n fue exitosa, False en caso contrario
    """
```

#### **Caracter√≠sticas T√©cnicas**:
- **Field ID Fijo**: Usa `"informe_crewai_2"` directamente (no busca din√°micamente)
- **Sintaxis GraphQL**: Utiliza mutaci√≥n `updateCardField` oficial de Pipefy
- **Escape de Contenido**: Maneja caracteres especiales para GraphQL
- **Logging Completo**: Registra cada paso del proceso

#### **Mutaci√≥n GraphQL Utilizada**:
```graphql
mutation {
    updateCardField(input: {
        card_id: CARD_ID, 
        field_id: "informe_crewai_2", 
        new_value: "ESCAPED_CONTENT"
    }) {
        card {
            id
            title
        }
    }
}
```

### 2. Funci√≥n de Detecci√≥n Autom√°tica (Fallback)

```python
async def get_pipefy_field_id_for_informe_crewai(card_id: str) -> Optional[str]:
    """
    Detecta autom√°ticamente el field_id del campo 'Informe CrewAI' en Pipefy.
    MEJORADO: Maneja el comportamiento espec√≠fico de Pipefy donde los campos
    solo aparecen en la API cuando tienen alg√∫n valor asignado.
    """
```

#### **Estrategias de B√∫squeda**:
1. **B√∫squeda Exacta**: `"Informe CrewAI"`
2. **B√∫squeda por Keywords**: `["informe crewai", "informe crew ai", "crewai informe"]`
3. **Manejo de Campos Vac√≠os**: Campos sin valor no aparecen en la API de Pipefy

### 3. Funci√≥n de Creaci√≥n Autom√°tica

```python
async def create_informe_crewai_field_in_phase(phase_id: str) -> Optional[str]:
    """
    Crea el campo 'Informe CrewAI' en una fase espec√≠fica de Pipefy.
    """
```

#### **Configuraci√≥n del Campo**:
- **Tipo**: `long_text`
- **Etiqueta**: `"Informe CrewAI"`
- **Descripci√≥n**: `"Informe generado autom√°ticamente por CrewAI con an√°lisis de documentos"`
- **Requerido**: `false`
- **Editable**: `true`

---

## üì§ Orquestaci√≥n del Proceso

### 1. Funci√≥n Orquestadora Principal

```python
async def handle_crewai_analysis_result(card_id: str, crew_response: Dict[str, Any]) -> Dict[str, Any]:
    """
    Orquestador principal que maneja los resultados del an√°lisis CrewAI.
    """
```

### 2. Puntos de Actualizaci√≥n del Campo

#### **A. Actualizaci√≥n Principal** (L√≠nea ~1600)
```python
# 1. Sempre atualizar o campo Informe CrewAI com o relat√≥rio detalhado
logger.info(f"üìù Atualizando campo 'Informe CrewAI' no card {card_id}")
informe_updated = await update_pipefy_informe_crewai_field(card_id, relatorio_detalhado)

if informe_updated:
    result["actions_executed"].append("informe_updated")
    logger.info(f"‚úÖ Campo 'Informe CrewAI' atualizado com sucesso")
else:
    result["errors"].append("failed_to_update_informe")
    logger.error(f"‚ùå Falha ao atualizar campo 'Informe CrewAI'")
```

#### **B. Actualizaci√≥n de Aprobaci√≥n** (L√≠nea ~1777)
```python
# Atualizar campo con mensagem de aprova√ß√£o
aprovacao_message = "‚úÖ **DOCUMENTA√á√ÉO APROVADA**\n\nTodos os documentos est√£o em conformidade com o checklist. O caso seguir√° para a pr√≥xima etapa de an√°lise de risco."
informe_aprovacao = await update_pipefy_informe_crewai_field(card_id, aprovacao_message)
```

---

## üìä Estructura del Contenido

### 1. Formato del Informe

El campo `informe_crewai_2` recibe contenido en **formato Markdown** con la siguiente estructura:

```markdown
# üìã RELAT√ìRIO DE AN√ÅLISE DE DOCUMENTOS

## üìä Resumo Executivo
- **Status Geral**: [Aprovado/Pendencia_Bloqueante/Pendencia_NaoBloqueante]
- **Total de Documentos**: X documentos analisados
- **Data da An√°lise**: YYYY-MM-DD HH:MM:SS

## üè¢ Informa√ß√µes da Empresa
- **Raz√£o Social**: [Nome da empresa]
- **CNPJ**: [XX.XXX.XXX/XXXX-XX]

## üìã An√°lise Detalhada

### ‚úÖ Documentos Aprovados
[Lista de documentos que atendem aos crit√©rios]

### ‚ö†Ô∏è Pend√™ncias Identificadas
[Lista de documentos/itens pendentes]

### üîß A√ß√µes Requeridas
[Lista de a√ß√µes espec√≠ficas necess√°rias]

## üéØ Conclus√£o
[Resumo das pr√≥ximas etapas]
```

### 2. Tipos de Status

#### **Status: "Aprovado"**
- Todos los documentos est√°n conformes
- Card se mueve a fase "Aprovado" (ID: `338000018`)
- Mensaje de aprobaci√≥n espec√≠fico

#### **Status: "Pendencia_Bloqueante"**
- Documentos cr√≠ticos faltantes
- Card se mueve a "Pend√™ncias Documentais" (ID: `338000017`)
- Env√≠a notificaci√≥n WhatsApp al gestor

#### **Status: "Pendencia_NaoBloqueante"**  
- Documentos menores pendientes
- Card se mueve a "Emitir documentos" (ID: `338000019`)
- Permite continuidad del proceso

---

## üîÑ Endpoints de Prueba y Debugging

### 1. Endpoints de Actualizaci√≥n Manual

#### **POST** `/test/update-pipefy-with-phase-handling`
```json
{
    "case_id": "CARD_ID",
    "informe_content": "Contenido del informe de prueba"
}
```

#### **POST** `/test/robust-field-handling`
```json
{
    "card_id": "CARD_ID",
    "test_content": "Contenido de prueba para el campo"
}
```

### 2. Endpoints de Detecci√≥n

#### **GET** `/test/field-detection/{card_id}`
- Detecta si el campo existe en el card
- Devuelve informaci√≥n del field_id
- √ötil para debugging

---

## üîÑ Integraci√≥n con Otros Sistemas

### 1. Almacenamiento en Supabase

Adem√°s de actualizar Pipefy, el informe tambi√©n se almacena en Supabase:

```python
# Tabla: informe_cadastro
{
    "case_id": "ID_DO_CARD",
    "informe": "CONTEUDO_MARKDOWN_COMPLETO",  # Mismo contenido que informe_crewai_2
    "risk_score": "ALTO|MEDIO|BAIXO",
    "analysis_details": { /* JSON estructurado */ },
    "documents_analyzed": 5,
    "status": "completed",
    "created_at": "2024-01-01T00:00:00Z"
}
```

### 2. Webhooks y Notificaciones

#### **Webhook de Supabase**: `/webhook/supabase/informe-created`
- Se dispara cuando se crea un registro en `informe_cadastro`
- Actualiza autom√°ticamente el campo `informe_crewai_2`
- Maneja el procesamiento completo del workflow

---

## üõ°Ô∏è Manejo de Errores

### 1. Estrategias de Recuperaci√≥n

#### **Error en Actualizaci√≥n**:
```python
try:
    informe_updated = await update_pipefy_informe_crewai_field(card_id, content)
    if not informe_updated:
        result["errors"].append("failed_to_update_informe")
        logger.error(f"‚ùå Falha ao atualizar campo 'Informe CrewAI'")
except Exception as e:
    logger.error(f"‚ùå Erro ao atualizar campo 'Informe CrewAI': {e}")
```

#### **Campo No Encontrado**:
- Log de debugging con campos disponibles
- Informaci√≥n de la fase actual del card
- Sugerencias para creaci√≥n manual del campo

### 2. Logs de Debugging

```python
logger.info(f"üîÑ Actualizando campo 'Informe CrewAI' para card: {card_id}")
logger.info(f"üìù Field ID fijo: informe_crewai_2")
logger.info(f"‚úÖ Campo 'Informe CrewAI' atualizado com sucesso!")
logger.info(f"   - Card ID: {card_info.get('id')}")
logger.info(f"   - Card Title: {card_info.get('title')}")
logger.info(f"   - Conte√∫do: {informe_content[:100]}...")
```

---

## üß™ Testing

### 1. Tests Unitarios

Ubicaci√≥n: `tests/unit/test_pipefy_functions.py`

```python
async def test_update_pipefy_informe_crewai_field_success():
    """Prueba actualizaci√≥n exitosa del campo informe_crewai_2"""
    
async def test_get_pipefy_field_id_for_informe_crewai():
    """Prueba detecci√≥n autom√°tica del field_id"""
    
async def test_create_informe_crewai_field_in_phase():
    """Prueba creaci√≥n autom√°tica del campo en una fase"""
```

### 2. Tests de Integraci√≥n

```python
# Archivo: test_flujo_completo.py
# Verificar si el campo informe_crewai_2 fue actualizado
informe_field = next((f for f in fields if f.get('field', {}).get('id') == 'informe_crewai_2'), None)
if informe_field and informe_field.get('value'):
    print(f"‚úÖ Campo 'informe_crewai_2' actualizado correctamente")
else:
    print(f"‚ö†Ô∏è Campo 'informe_crewai_2' no encontrado o vac√≠o")
```

---

## üìö Referencias y Configuraci√≥n

### 1. Variables de Entorno

```bash
# .env
FIELD_ID_INFORME=informe_crewai_2
PIPEFY_TOKEN=your_pipefy_token_here
PHASE_ID_APROVADO=338000018
PHASE_ID_PENDENCIAS=338000017
PHASE_ID_EMITIR_DOCS=338000019
```

### 2. Endpoints del Servicio CrewAI

```bash
# An√°lisis de documentos
POST https://pipefy-crewai-analysis-modular.onrender.com/analyze
```

### 3. Fases de Pipefy

| Fase | ID | Descripci√≥n |
|------|----|----|
| Aprovado | `338000018` | Documentos conformes |
| Pend√™ncias Documentais | `338000017` | Pendencias bloqueantes |
| Emitir documentos | `338000019` | Pendencias no bloqueantes |
| Triagem | `338000020` | Fase inicial (webhook trigger) |

---

## üí° Mejores Pr√°cticas

### 1. **Field ID Fijo vs Detecci√≥n Din√°mica**
- ‚úÖ **Usar**: Field ID fijo `"informe_crewai_2"`
- ‚ùå **Evitar**: B√∫squedas din√°micas en cada actualizaci√≥n
- üìù **Raz√≥n**: Mayor rendimiento y confiabilidad

### 2. **Escape de Contenido para GraphQL**
```python
escaped_content = informe_content.replace('"', '\\"').replace('\n', '\\n').replace('\r', '')
```

### 3. **Logging Estructurado**
- Usar emojis para categorizaci√≥n visual
- Incluir IDs de card y field para debugging
- Mostrar primeros 100 caracteres del contenido

### 4. **Manejo de Errores Graceful**
- No fallar toda la operaci√≥n si el campo no se actualiza
- Log detallado para debugging
- Continuar con otras operaciones (movimiento de card, notificaciones)

---

## üîÑ Flujo de Datos Completo

```
1. üì• WEBHOOK PIPEFY (Fase Triagem)
   ‚Üì
2. üìé DESCARGAR DOCUMENTOS
   ‚Üì
3. ‚òÅÔ∏è SUBIR A SUPABASE STORAGE  
   ‚Üì
4. ü§ñ AN√ÅLISIS CREWAI
   ‚Üì
5. üìù **ACTUALIZAR informe_crewai_2**
   ‚Üì
6. üíæ GUARDAR EN SUPABASE DB
   ‚Üì
7. üîÑ MOVER CARD SEG√öN CLASIFICACI√ìN
   ‚Üì
8. üì± NOTIFICACIONES (si es necesario)
```

---

*Este documento cubre todos los aspectos t√©cnicos del rellenado program√°tico del campo `informe_crewai_2`. Para m√°s detalles sobre otros componentes del sistema, consultar la documentaci√≥n espec√≠fica de cada m√≥dulo.* 